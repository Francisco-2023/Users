{% extends 'base.html' %}
{% block title %}üìã Lista de Tickets{% endblock %}

{% block content %}
<div class="container mt-4">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h2 class="text-primary">üé´ Lista de Tickets</h2>
    <button class="btn btn-success" data-bs-toggle="modal" data-bs-target="#modalCrearTicket">
      ‚ûï Crear Ticket
    </button>
  </div>

  <div class="row">
    {% for ticket in tickets %}
    <div class="col-md-6 col-lg-4 mb-4">
      <div class="card shadow-sm border rounded-4 h-100">
        <div class="card-header bg-primary text-white rounded-top-4">
          <h5 class="mb-0 d-flex align-items-center gap-2">
            <i class="bi bi-ticket-perforated-fill fs-4"></i>
            Ticket #{{ ticket.id }}
          </h5>
        </div>

        <div class="card-body">
          <!-- contenido igual que antes -->
          <div class="row gy-3">
            <div class="col-md-6">
              <h6 class="text-secondary fw-semibold">Informaci√≥n del Contrato</h6>
              <p><strong>Contrato:</strong> {{ ticket.numero_contrato }}</p>
              <p><strong>Usuario:</strong> {{ ticket.usuario }}</p>
              <p><strong>Tel√©fono:</strong> <a href="tel:{{ ticket.phone }}" class="text-decoration-none">{{
                  ticket.phone }}</a></p>
              <p><strong>Direcci√≥n:</strong> {{ ticket.address_reference }}</p>
            </div>

            <div class="col-md-6">
              <h6 class="text-secondary fw-semibold">Detalles del Ticket</h6>
              <p><strong>Descripci√≥n:</strong> {{ ticket.descripcion }}</p>
              <p><strong>Categor√≠a:</strong> {{ ticket.categoria }}</p>
              <p><strong>Prioridad:</strong> <span class="badge bg-warning text-dark">{{ ticket.prioridad }}</span></p>
              <p><strong>Asignado a:</strong> {{ ticket.assigned_to }}</p>
            </div>
          </div>

          <hr>

          <div class="d-flex justify-content-between align-items-center flex-wrap gap-3">
            <div>
              <small class="text-muted"><strong>Fecha:</strong> {{ ticket.fecha.strftime('%Y-%m-%d %H:%M') }}</small>
            </div>
            <div>
              <small><strong>Estado:</strong>
                <span class="badge 
            {% if ticket.estado == 'Hecho' %} bg-success
            {% elif ticket.estado == 'Cancelado' %} bg-danger
            {% elif ticket.estado == 'En espera' %} bg-warning text-dark
            {% else %} bg-info text-dark
            {% endif %}">
                  {{ ticket.estado }}
                </span>
              </small>
            </div>
          </div>

          <form method="POST" action="/actualizar_estado/{{ ticket.id }}" class="mt-3" style="max-width: 280px;">
            <label for="estado-select" class="form-label fw-semibold">Cambiar estado</label>
            <div class="input-group input-group-sm">
              <select id="estado-select" name="estado" class="form-select" aria-label="Cambiar estado">
                {% for estado in ['Pendiente', 'Asignado', 'En espera', 'Hecho', 'Cancelado'] %}
                <option value="{{ estado }}" {% if ticket.estado==estado %}selected{% endif %}>{{ estado }}</option>
                {% endfor %}
              </select>
              <button class="btn btn-primary" type="submit" title="Guardar Estado">
                <i class="bi bi-check-lg"></i>
              </button>
            </div>
          </form>
        </div>

        <div class="card-footer bg-light rounded-bottom-4">
          <!-- Grupo superior: Editar y Eliminar -->
          <div class="d-flex flex-wrap justify-content-center justify-content-md-start gap-3 mb-3">
            <button class="btn btn-outline-primary btn-custom" data-bs-toggle="modal"
              data-bs-target="#modalEditarTicket{{ ticket.id }}" type="button" title="Editar Ticket">
              <i class="bi bi-pencil"></i> Editar
            </button>

            <form method="POST" action="/eliminar_ticket/{{ ticket.id }}"
              onsubmit="return confirm('¬øEst√°s seguro de eliminar este ticket?')" class="m-0"
              style="display: inline-block;">
              <button type="submit" class="btn btn-outline-danger btn-custom" title="Eliminar Ticket">
                <i class="bi bi-trash"></i> Eliminar
              </button>
            </form>
          </div>

          <!-- Grupo inferior: Reportes -->
          <div class="d-flex flex-wrap justify-content-center justify-content-md-start gap-3">
            <a href="{{ url_for('reporte', ticket_id=ticket.id) }}" class="btn btn-outline-success btn-custom"
              title="Crear Reporte T√©cnico">
              <i class="bi bi-tools"></i> Reporte T√©cnico
            </a>

            {% if ticket.reporte_id %}
            <a href="{{ url_for('ver_reporte', reporte_id=ticket.reporte_id) }}" class="btn btn-outline-info btn-custom"
              title="Ver Reporte T√©cnico">
              <i class="bi bi-eye"></i> Ver Reporte
            </a>
            {% endif %}
          </div>
        </div>

      </div>


      <!-- MODAL EDITAR TICKET -->
      <div class="modal fade" id="modalEditarTicket{{ ticket.id }}" tabindex="-1"
        aria-labelledby="modalEditarTicketLabel{{ ticket.id }}" aria-hidden="true">
        <div class="modal-dialog modal-lg">
          <form method="POST" action="/actualizar_ticket/{{ ticket.id }}">
            <div class="modal-content">
              <div class="modal-header">
                <h5 class="modal-title">‚úèÔ∏è Editar Ticket #{{ ticket.id }}</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
              </div>
              <div class="modal-body">
                <div class="row">
                  <div class="mb-3 col-md-6">
                    <label>Usuario</label>
                    <input type="text" name="usuario" class="form-control" value="{{ ticket.usuario }}" required>
                  </div>
                  <div class="mb-3 col-md-6">
                    <label>Contrato</label>
                    <select name="numero_contrato" class="form-select" required>
                      {% for contrato in contratos %}
                      <option value="{{ contrato.numero_contrato }}" {% if
                        contrato.numero_contrato==ticket.numero_contrato %}selected{% endif %}>
                        {{ contrato.numero_contrato }} - {{ contrato.nombres }} {{ contrato.apellidos }}
                      </option>
                      {% endfor %}
                    </select>
                  </div>
                  <div class="mb-3 col-md-6">
                    <label>Tel√©fono</label>
                    <input type="text" name="phone" class="form-control" value="{{ ticket.phone }}">
                  </div>
                  <div class="mb-3 col-md-6">
                    <label>Referencia de Direcci√≥n</label>
                    <input type="text" name="address_reference" class="form-control"
                      value="{{ ticket.address_reference }}">
                  </div>
                  <div class="mb-3 col-md-12">
                    <label>Descripci√≥n</label>
                    <textarea name="descripcion" class="form-control" required>{{ ticket.descripcion }}</textarea>
                  </div>
                  <div class="mb-3 col-md-6">
                    <label>Categor√≠a</label>
                    <select name="categoria" class="form-select">
                      {% for cat in ['Instalaci√≥n', 'Soporte', 'Revisi√≥n T√©cnica', 'Suspensi√≥n', 'Otro'] %}
                      <option value="{{ cat }}" {% if ticket.categoria==cat %}selected{% endif %}>{{ cat }}</option>
                      {% endfor %}
                    </select>
                  </div>
                  <div class="mb-3 col-md-6">
                    <label>Prioridad</label>
                    <select name="prioridad" class="form-select">
                      {% for pri in ['Baja', 'Media', 'Alta'] %}
                      <option value="{{ pri }}" {% if ticket.prioridad==pri %}selected{% endif %}>{{ pri }}</option>
                      {% endfor %}
                    </select>
                  </div>
                  <div class="mb-3 col-md-6">
                    <label>Asignado a</label>
                    <select name="assigned_to" class="form-select">
                      {% for tecnico in ['Tecnico Francisco', 'Tecnico Gabriela', 'Tecnico Jose', 'Tecnico Juan', 'Sin
                      asignar'] %}
                      <option value="{{ tecnico }}" {% if ticket.assigned_to==tecnico %}selected{% endif %}>{{ tecnico
                        }}
                      </option>
                      {% endfor %}
                    </select>
                  </div>
                  <div class="mb-3 col-md-6">
                    <label>Estado</label>
                    <select name="estado" class="form-select">
                      {% for estado in ['Pendiente', 'Asignado', 'En espera', 'Hecho', 'Cancelado'] %}
                      <option value="{{ estado }}" {% if ticket.estado==estado %}selected{% endif %}>{{ estado }}
                      </option>
                      {% endfor %}
                    </select>
                  </div>
                </div>
              </div>
              <div class="modal-footer">
                <button type="submit" class="btn btn-primary">üíæ Guardar Cambios</button>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
              </div>
            </div>
          </form>
        </div>
      </div>
      {% endfor %}
    </div>
  </div>

  <!-- MODAL CREAR TICKET -->
  <div class="modal fade" id="modalCrearTicket" tabindex="-1" aria-labelledby="modalCrearTicketLabel"
    aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <form method="POST" action="/crear_ticket">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">üìù Crear Nuevo Ticket</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <div class="row">
              <div class="mb-3 col-md-6">
                <label>Usuario</label>
                <input type="text" class="form-control" value="{{ session['username'] }}" readonly>
                <input type="hidden" name="usuario" value="{{ session['username'] }}">
              </div>

              <div class="mb-3 col-md-6">
                <label>Contrato</label>
                <select name="numero_contrato" class="form-select" required>
                  <option value="" disabled selected>Seleccione contrato</option>
                  {% for contrato in contratos %}
                  <option value="{{ contrato.numero_contrato }}">{{ contrato.numero_contrato }} - {{ contrato.nombres }}
                    {{ contrato.apellidos }}</option>
                  {% endfor %}
                </select>
              </div>
              <div class="mb-3 col-md-6">
                <label>Tel√©fono</label>
                <input type="text" name="phone" class="form-control">
              </div>
              <div class="mb-3 col-md-6">
                <label>Referencia de Direcci√≥n</label>
                <input type="text" name="address_reference" class="form-control">
              </div>
              <div class="mb-3 col-md-12">
                <label>Descripci√≥n</label>
                <textarea name="descripcion" class="form-control" required></textarea>
              </div>
              <div class="mb-3 col-md-6">
                <label>Categor√≠a</label>
                <select name="categoria" class="form-select">
                  {% for cat in ['Instalaci√≥n', 'Soporte', 'Revisi√≥n T√©cnica', 'Suspensi√≥n', 'Otro'] %}
                  <option value="{{ cat }}">{{ cat }}</option>
                  {% endfor %}
                </select>
              </div>
              <div class="mb-3 col-md-6">
                <label>Prioridad</label>
                <select name="prioridad" class="form-select">
                  {% for pri in ['Baja', 'Media', 'Alta'] %}
                  <option value="{{ pri }}">{{ pri }}</option>
                  {% endfor %}
                </select>
              </div>
              <div class="mb-3 col-md-6">
                <label>Asignado a</label>
                <select name="assigned_to" class="form-select">
                  {% for tecnico in ['Tecnico Francisco', 'Tecnico Gabriela', 'Tecnico Jose', 'Tecnico Juan', 'Sin
                  asignar'] %}
                  <option value="{{ tecnico }}">{{ tecnico }}</option>
                  {% endfor %}
                </select>
              </div>
            </div>
          </div>
          <div class="modal-footer">
            <button type="submit" class="btn btn-primary">Guardar Ticket</button>
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
          </div>
        </div>
      </form>
    </div>
  </div>

  <!-- SweetAlert2 -->
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script>
    function mostrarMensaje(mensaje, tipo = 'success') {
      Swal.fire({
        icon: tipo === 'error' ? 'error' : (tipo === 'warning' ? 'warning' : 'success'),
        title: mensaje,
        showConfirmButton: false,
        timer: 2000
      });
    }

    document.addEventListener('DOMContentLoaded', () => {
      const flashMessages = [
        {% for category, message in get_flashed_messages(with_categories = true) %}
      { category: "{{ category }}", message: "{{ message }}" },
      {% endfor %}
    ];

    flashMessages.forEach(flash => {
      mostrarMensaje(flash.message, flash.category);
    });
  });
  </script>
  {% endblock %}