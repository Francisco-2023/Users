{% extends "base.html" %}
{% block title %}Resumen Financiero{% endblock %}

{% block content %}
<div class="container mt-5 mb-5">
    <h2 class="text-primary mb-4 text-center fw-bold">📊 Resumen Financiero</h2>

    <!-- Tarjetas resumen -->
    <div class="row mb-5 g-4 justify-content-center">
        {% set card_styles = [
        {'icon':'💵', 'title':'Total Diario', 'color':'success', 'value': total_diario},
        {'icon':'📅', 'title':'Total Mensual', 'color':'primary', 'value': total_mensual},
        {'icon':'📈', 'title':'Total Anual', 'color':'dark', 'value': total_anual},
        {'icon':'💰', 'title':'Total General', 'color':'danger', 'value': total_general}
        ] %}
        {% for card in card_styles %}
        <div class="col-12 col-sm-6 col-md-4 col-lg-3">
            <div class="card border-0 shadow-sm bg-light h-100">
                <div class="card-body text-center py-4">
                    <div class="mb-3 fs-2 text-{{ card.color }}">{{ card.icon }}</div>
                    <h6 class="card-title text-uppercase fw-semibold text-{{ card.color }}">{{ card.title }}</h6>
                    <h4 class="fw-bold text-{{ card.color }}">${{ "%.2f"|format(card.value if card.value else 0) }}</h4>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>

    <!-- Gráfico mensual: ocupa fila completa -->
    <div class="card shadow-sm mb-5">
        <div class="card-body">
            <h5 class="card-title fw-semibold mb-3">Totales por Mes</h5>
            <canvas id="graficoMensual" style="max-height: 300px;"></canvas>
        </div>
    </div>

    <!-- Fila con los 3 gráficos alineados -->
    <div class="row g-4 mb-5">
        <div class="col-12 col-md-4">
            <div class="card shadow-sm h-100">
                <div class="card-body">
                    <h5 class="card-title fw-semibold mb-3">Ingresos por Método de Pago</h5>
                    <canvas id="graficoMetodosPago" style="max-height: 250px;"></canvas>
                </div>
            </div>
        </div>
        <div class="col-12 col-md-4">
            <div class="card shadow-sm h-100">
                <div class="card-body">
                    <h5 class="card-title fw-semibold mb-3">Ingresos por Plan</h5>
                    <canvas id="graficoPlanes" style="max-height: 250px;"></canvas>
                </div>
            </div>
        </div>
        <div class="col-12 col-md-4">
            <div class="card shadow-sm h-100">
                <div class="card-body">
                    <h5 class="card-title fw-semibold mb-3">Ingresos por Año</h5>
                    <canvas id="graficoAnual" style="max-height: 250px;"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- Buscador -->
    <div class="mb-3">
        <input type="search" id="buscador" class="form-control form-control-lg"
            placeholder="🔍 Buscar por cliente, plan o método de pago...">
    </div>

    <!-- Tabla de pagos -->
    <!-- Tabla con campos importantes -->
    <div class="table-responsive shadow-sm rounded">
        <table class="table table-striped table-hover align-middle text-center" id="tabla-pagos">
            <thead class="table-dark align-middle">
                <tr>
                    <th>Número Contrato</th>
                    <th>Cliente</th>
                    <th>Plan Guardado</th>
                    <th>Monto (USD)</th>
                    <th>Método Pago</th>
                    <th>Fecha Pago</th>
                    <th>Estado Contrato</th>
                </tr>
            </thead>
            <tbody>
                {% for pago in pagos %}
                <tr>
                    <td>{{ pago.numero_contrato or '-' }}</td>
                    <td>{{ pago.cliente or '-' }}</td>
                    <td>{{ pago.plan_internet_guardado or '-' }}</td>
                    <td>${{ "%.2f"|format(pago.monto if pago.monto else 0) }}</td>
                    <td>{{ pago.metodo_pago or '-' }}</td>
                    <td>{{ pago.fecha.strftime('%Y-%m-%d %H:%M:%S') if pago.fecha else '-' }}</td>
                    <td>{{ pago.estado or '-' }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

</div>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    // Gráfico mensual
    const ctxMensual = document.getElementById('graficoMensual').getContext('2d');
    new Chart(ctxMensual, {
        type: 'bar',
        data: {
            labels: {{ labels| tojson }},
        datasets: [{
            label: 'Ingresos Mensuales (USD)',
            data: {{ valores| tojson }},
        backgroundColor: 'rgba(33, 150, 243, 0.7)',
        borderColor: 'rgba(33, 150, 243, 1)',
        borderWidth: 1,
        borderRadius: 5,
        maxBarThickness: 40
            }]
        },
        options: {
        responsive: true,
        plugins: {
            legend: { display: false },
            tooltip: { mode: 'index', intersect: false }
        },
        scales: {
            y: { beginAtZero: true, ticks: { precision: 0 } }
        }
    }
    });

    // Gráfico métodos de pago (pie)
    const ctxMetodos = document.getElementById('graficoMetodosPago').getContext('2d');
    new Chart(ctxMetodos, {
        type: 'pie',
        data: {
            labels: {{ metodos| tojson }},
        datasets: [{
            label: 'Ingresos por Método',
            data: {{ valores_metodos| tojson }},
        backgroundColor: [
            'rgba(54, 162, 235, 0.7)',
            'rgba(255, 206, 86, 0.7)',
            'rgba(75, 192, 192, 0.7)',
            'rgba(255, 99, 132, 0.7)',
            'rgba(153, 102, 255, 0.7)',
            'rgba(255, 159, 64, 0.7)'
        ],
        borderColor: [
            'rgba(54, 162, 235, 1)',
            'rgba(255, 206, 86, 1)',
            'rgba(75, 192, 192, 1)',
            'rgba(255, 99, 132, 1)',
            'rgba(153, 102, 255, 1)',
            'rgba(255, 159, 64, 1)'
        ],
        borderWidth: 1
            }]
        },
        options: {
        responsive: true,
        plugins: {
            legend: { position: 'right' },
            tooltip: { enabled: true }
        }
    }
    });

    // Gráfico ingresos por plan (bar)
    const ctxPlanes = document.getElementById('graficoPlanes').getContext('2d');
    new Chart(ctxPlanes, {
        type: 'bar',
        data: {
            labels: {{ planes| tojson }},
        datasets: [{
            label: 'Ingresos por Plan (USD)',
            data: {{ valores_planes| tojson }},
        backgroundColor: 'rgba(75, 192, 192, 0.7)',
        borderColor: 'rgba(75, 192, 192, 1)',
        borderWidth: 1,
        borderRadius: 5,
        maxBarThickness: 40
            }]
        },
        options: {
        responsive: true,
        plugins: {
            legend: { display: false },
            tooltip: { mode: 'index', intersect: false }
        },
        scales: {
            y: { beginAtZero: true, ticks: { precision: 0 } }
        }
    }
    });

    // Gráfico ingresos anuales (line)
    const ctxAnual = document.getElementById('graficoAnual').getContext('2d');
    new Chart(ctxAnual, {
        type: 'line',
        data: {
            labels: {{ labels_anual| tojson }},
        datasets: [{
            label: 'Ingresos Anuales (USD)',
            data: {{ valores_anual| tojson }},
        fill: false,
        borderColor: 'rgba(255, 99, 132, 0.8)',
        backgroundColor: 'rgba(255, 99, 132, 0.4)',
        tension: 0.3,
        pointRadius: 5,
        pointHoverRadius: 7
            }]
        },
        options: {
        responsive: true,
        plugins: {
            legend: { display: true, position: 'top' },
            tooltip: { enabled: true }
        },
        scales: {
            y: { beginAtZero: true, ticks: { precision: 0 } }
        }
    }
    });

    // Buscador dinámico
    document.getElementById('buscador').addEventListener('input', function () {
        const filtro = this.value.toLowerCase();
        document.querySelectorAll('#tabla-pagos tbody tr').forEach(fila => {
            fila.style.display = fila.textContent.toLowerCase().includes(filtro) ? '' : 'none';
        });
    });
</script>
{% endblock %}