{% extends "base.html" %}
{% block title %}Monitoreo DHCP Mejorado{% endblock %}

{% block content %}
<div class="container py-5">
    <h1 class="text-center fw-bold mb-5 text-primary">Monitoreo de Leases DHCP</h1>

    <div class="row mb-4 justify-content-center">
        <div class="col-md-6 mb-3">
            <input type="text" id="filter-ip" class="form-control shadow-sm" placeholder="Filtrar por IP o MAC">
        </div>
        <div class="col-md-4 mb-3">
            <select id="filter-status" class="form-select shadow-sm">
                <option value="">Todos los estados</option>
                <option value="bound">Conectados</option>
                <option value="offline">Desconectados</option>
            </select>
        </div>
    </div>

    {% for server, leases in leases_grouped.items() %}
    <div class="card shadow-sm mb-5 rounded-4 border-0">
        <div class="card-header bg-primary text-white rounded-top-4 d-flex align-items-center">
            <i class="bi bi-hdd-network fs-4 me-2"></i>
            <h5 class="mb-0">{{ server }}</h5>
        </div>
        <div class="card-body bg-light rounded-bottom-4">
            {% if leases %}
            <div class="table-responsive">
                <table class="table table-hover table-bordered align-middle mb-0">
                    <thead class="table-primary text-primary text-center">
                        <tr>
                            <th>IP</th>
                            <th>MAC</th>
                            <th>Hostname</th>
                            <th>Estado</th>
                            <th>Tiempo restante</th>
                            <th>Acción</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for lease in leases %}
                        <tr class="lease-row" data-ip="{{ lease.address }} {{ lease['mac-address'] }}" data-status="{{ lease.status }}" id="lease-{{ lease['.id'] }}">
                            <td>{{ lease.address or 'N/A' }}</td>
                            <td>{{ lease['mac-address'] or 'N/A' }}</td>
                            <td>{{ lease['host-name'] or 'Sin nombre' }}</td>
                            <td class="text-center">
                                {% if lease.status == "bound" %}
                                    <span class="badge bg-success">Activo</span>
                                {% else %}
                                    <span class="badge bg-secondary">Inactivo</span>
                                {% endif %}
                            </td>
                            <td class="remaining-time text-center" data-expires="{{ lease['expires-after'] | default('0s') }}">
                                {{ lease['expires-after'] or '0s' }}
                            </td>
                            <td class="text-center">
                                <button class="btn btn-sm btn-outline-danger" onclick="deleteLease('{{ lease['.id'] }}')">
                                    <i class="bi bi-trash"></i> Eliminar
                                </button>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
                <p class="text-muted text-center">No hay arrendamientos activos para este servidor.</p>
            {% endif %}
        </div>
    </div>
    {% endfor %}
</div>

<!-- Bootstrap Icons -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">

<style>
    body {
        background-color: #f8fbff;
        color: #0d3b66;
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }
    .card-header {
        box-shadow: 0 4px 10px rgba(13, 59, 102, 0.15);
    }
    .table-primary {
        background-color: #cfe2ff !important;
    }
    .badge.bg-success {
        background-color: #198754 !important;
    }
    .badge.bg-secondary {
        background-color: #6c757d !important;
    }
    button.btn-outline-danger {
        transition: background-color 0.3s ease, color 0.3s ease;
    }
    button.btn-outline-danger:hover {
        background-color: #dc3545;
        color: white;
    }
    input.form-control, select.form-select {
        border-radius: 0.4rem;
        border: 1px solid #0d3b66;
        box-shadow: 0 0 10px rgba(13, 59, 102, 0.15);
        transition: box-shadow 0.3s ease;
    }
    input.form-control:focus, select.form-select:focus {
        box-shadow: 0 0 12px #0d3b66;
        border-color: #0a2e58;
        outline: none;
    }
</style>

<script>
function deleteLease(id) {
    if (!confirm('¿Estás seguro de eliminar este lease DHCP?')) return;

    fetch(`/dhcp/delete/${id}`, { method: 'POST' })
        .then(res => res.json())
        .then(data => {
            if (data.success) {
                const row = document.getElementById(`lease-${id}`);
                if (row) row.remove();
            } else {
                alert("Error: " + data.error);
            }
        })
        .catch(err => alert("Error: " + err));
}

setInterval(() => {
    document.querySelectorAll('.remaining-time').forEach(el => {
        const raw = el.dataset.expires.trim();
        if (raw === "0s" || raw === "") {
            el.textContent = "0s";
            return;
        }

        const match = raw.match(/(?:(\d+)d)?(?:(\d+)h)?(?:(\d+)m)?(?:(\d+)s)?/);
        if (!match) return;

        let [ , d, h, m, s ] = match.map(x => parseInt(x) || 0);
        let total = (((d * 24 + h) * 60 + m) * 60 + s) - 1;

        if (total <= 0) {
            el.textContent = "0s";
            const statusCell = el.closest('tr').querySelector('td:nth-child(4) span');
            if (statusCell) {
                statusCell.textContent = 'Inactivo';
                statusCell.className = 'badge bg-secondary';
            }
            return;
        }

        const dd = Math.floor(total / 86400);
        const hh = Math.floor((total % 86400) / 3600);
        const mm = Math.floor((total % 3600) / 60);
        const ss = total % 60;

        let newTime = '';
        if (dd > 0) newTime += `${dd}d`;
        if (hh > 0) newTime += `${hh}h`;
        if (mm > 0) newTime += `${mm}m`;
        newTime += `${ss}s`;

        el.dataset.expires = newTime;
        el.textContent = newTime;
    });
}, 1000);

const filterIP = document.getElementById('filter-ip');
const filterStatus = document.getElementById('filter-status');

function applyFilters() {
    const ipText = filterIP.value.toLowerCase();
    const status = filterStatus.value;

    document.querySelectorAll('.lease-row').forEach(row => {
        const ipMatch = row.dataset.ip.toLowerCase().includes(ipText);
        const statusMatch = !status || row.dataset.status === status;

        row.style.display = (ipMatch && statusMatch) ? '' : 'none';
    });
}

filterIP.addEventListener('input', applyFilters);
filterStatus.addEventListener('change', applyFilters);
</script>
{% endblock %}
